# FFmpeg层配置指南

## 🎯 问题诊断

如果视频转GIF功能仍然失败，请按以下步骤检查：

### 1. 检查层绑定状态

在微信开发者工具中：
1. 右键点击 `cloudfunctions/videoToGif` 
2. 选择"云函数详情" 
3. 查看"层"选项卡，确认FFmpeg层已绑定

### 2. 验证层内容

检查层的目录结构应该是：
```
ffmpeg-layer/
└── bin/
    └── ffmpeg  (可执行文件)
```

### 3. 重新上传层（如果需要）

如果层配置有问题，请：

1. **删除测试文件**：
   ```bash
   rm cloudfunctions/videoToGif/test-ffmpeg.js
   ```

2. **重新上传云函数**：
   - 在微信开发者工具中右键 `cloudfunctions/videoToGif`
   - 选择"上传并部署：云端安装依赖"

3. **测试云函数**：
   - 在云开发控制台中找到 `videoToGif` 云函数
   - 点击"测试"，使用以下测试数据：
   ```json
   {
     "fileID": "cloud://test",
     "width": 200,
     "height": 200,
     "duration": 3,
     "fps": 10
   }
   ```

## 🔧 常见问题解决

### 问题1: FFMPEG_NOT_FOUND
**原因**: FFmpeg层未正确绑定或路径不对

**解决方法**:
1. 确认在云开发控制台中正确创建了FFmpeg层
2. 确认云函数已绑定该层
3. 检查层的目录结构

### 问题2: FFmpeg处理失败
**原因**: FFmpeg命令参数有误或视频格式不支持

**解决方法**:
1. 检查视频文件是否有效
2. 查看云函数日志中的FFmpeg错误信息
3. 尝试使用较小的视频文件测试

### 问题3: 内存或超时错误
**原因**: 视频文件太大或处理时间过长

**解决方法**:
1. 限制视频文件大小（建议<10MB）
2. 缩短GIF持续时间（建议<5秒）
3. 降低帧率和分辨率

## 📋 测试步骤

1. **部署更新后的云函数**
2. **在小程序中测试视频上传**
3. **查看云函数日志**：
   - 在云开发控制台 → 云函数 → videoToGif → 日志
   - 查看是否有 "找到FFmpeg路径" 的日志
   - 检查是否有FFmpeg错误

## 🚨 调试提示

如果问题仍然存在，请：

1. **查看完整的云函数日志**
2. **检查返回的错误信息**
3. **确认视频文件格式**（建议使用MP4格式）
4. **测试较小的视频文件**（<5MB, <10秒）

## 💡 性能优化建议

- 设置合理的GIF参数：
  - 宽度: 200-300px
  - 持续时间: 3-5秒  
  - 帧率: 8-12fps
  - 这样可以平衡质量和文件大小

