<view class="container">
  <!-- 个人信息卡片 -->
  <view class="profile-card card p-16">
    <view class="profile-avatar-container">
      <image class="profile-avatar" src="{{userInfo.avatar}}" mode="aspectFill" lazy-load="true"></image>
      <view class="rank-tag">#{{userInfo.rank}}</view>
    </view>
    
    <text class="profile-name h2">{{userInfo.name}}</text>
    <text class="profile-title text-body">伦敦得吃王者</text>
    
    <view class="badge-row flex justify-center gap-12 my-16">
      <view class="badge badge-red">🔥 火热榜首</view>
      <view class="badge badge-purple">连续3周第一</view>
    </view>
    
    <view class="points-display flex justify-center items-center">
      <text class="points-number">{{userInfo.votes}}</text>
      <text class="points-label text-body">人想吃</text>
    </view>
  </view>

  <!-- 操作按钮组 -->
  <view class="action-buttons card p-16">
    <button class="action-btn btn btn-accent-green" bindtap="handleVote">
      <text class="btn-icon">👍</text>
      <text class="btn-text">投票</text>
    </button>
    <button class="action-btn btn btn-secondary" bindtap="handleDownVote">
      <text class="btn-icon">👎</text>
      <text class="btn-text">减票</text>
    </button>
    <button class="action-btn btn btn-secondary" open-type="share">
      <text class="btn-icon">↗</text>
      <text class="btn-text">分享</text>
    </button>
  </view>

  <!-- 音效功能区 -->
  <view class="sound-section card p-16">
    <view class="custom-flex-row">
      <button class="sound-btn btn btn-accent-purple custom-flex-large" bindtap="playSound">
        <text class="btn-icon">🎤</text>
        <text class="btn-text">录制投票音效</text>
      </button>
      <button class="record-btn btn btn-secondary custom-flex-small" bindtap="recordSound">
        <text class="btn-icon">✓</text>
        <text class="btn-text">确认音效</text>
      </button>
    </view>
  </view>

  <!-- 弹幕输入区 -->
  <view class="danmaku-input-section card p-16">
    <view class="custom-flex-row">
      <input 
        class="danmaku-input input custom-flex-large"
        placeholder="发个弹幕调侃一下..." 
        value="{{danmakuText}}" 
        bindinput="onDanmakuInput"
      />
      <button class="action-btn btn btn-accent-purple custom-flex-small" bindtap="sendDanmaku">
        <text class="btn-icon">✈️</text>
        <text class="btn-text">发送</text>
      </button>
    </view>
  </view>

  <!-- 战绩墙 -->
  <view class="achievements-section card p-16 mb-16">
    <view class="section-header flex items-center mb-16">
      <text class="section-icon">🏆</text>
      <text class="section-title h2">战绩墙</text>
    </view>
    
    <view class="achievements-list">
      <view class="achievement-item {{item.type === 'success' ? 'success' : item.type === 'fail' ? 'fail' : 'neutral'}}" 
        wx:for="{{achievements}}" 
        wx:key="id"
      >
        <view class="achievement-content">
          <text class="achievement-text text-body">{{item.content}}</text>
          <view class="achievement-meta flex gap-8">
            <text class="achievement-date text-small">{{item.date}}</text>
            <text wx:if="{{item.location}}" class="achievement-location text-small">· {{item.location}}</text>
          </view>
        </view>
      </view>
      
      <button class="add-achievement-btn" bindtap="addAchievement">
        <text class="add-icon">➕</text>
        <text class="add-text text-body">爆料新事迹</text>
      </button>
    </view>
  </view>
  
  <!-- 评论区 -->
  <view class="comments-section card p-16 mb-16">
    <view class="section-header flex items-center mb-16">
      <text class="section-icon">💬</text>
      <text class="section-title h2">评论区 ({{commentCount || 0}})</text>
    </view>
    
    <!-- 评论输入框 -->
    <view class="comment-input-container mb-16">
      <input 
        class="comment-input input" 
        placeholder="{{replyTo ? '回复 '+replyTo+'...' : '添加评论...'}}" 
        value="{{commentContent}}"
        bindinput="onCommentInput" 
      />
      <button class="comment-submit-btn btn btn-accent-purple" bindtap="submitComment">
        <text class="btn-text">发送</text>
      </button>
    </view>
    
    <!-- 评论列表 -->
    <view class="comments-list">
      <block wx:if="{{comments.length > 0}}">
        <!-- 顶级评论 -->
        <view class="comment-item" wx:for="{{comments}}" wx:key="_id">
          <view class="comment-user">
            <image class="comment-avatar" src="{{item.creatorAvatar}}" mode="aspectFill"></image>
            <view class="comment-user-info">
              <text class="comment-username">{{item.creatorName}}</text>
              <text class="comment-time">{{formatTime(item.createTime)}}</text>
            </view>
          </view>
          <view class="comment-content">{{item.content}}</view>
          <view class="comment-actions">
            <view class="action-item" bindtap="replyComment" data-id="{{item._id}}" data-name="{{item.creatorName}}">
              <text class="action-icon">💬</text>
              <text class="action-text">回复</text>
            </view>
            <view class="action-item" bindtap="likeComment" data-id="{{item._id}}">
              <text class="action-icon">👍</text>
              <text class="action-text">{{item.likes || 0}}</text>
            </view>
          </view>
          
          <!-- 子评论列表 -->
          <view class="replies-container" wx:if="{{item.replies && item.replies.length > 0}}">
            <block wx:for="{{item.replies}}" wx:for-item="reply" wx:key="_id">
              <view class="reply-item">
                <view class="reply-user">
                  <image class="reply-avatar" src="{{reply.creatorAvatar}}" mode="aspectFill"></image>
                  <view class="reply-user-info">
                    <text class="reply-username">{{reply.creatorName}}</text>
                    <text class="reply-time">{{formatTime(reply.createTime)}}</text>
                  </view>
                </view>
                <view class="reply-content">
                  <text class="reply-to" wx:if="{{reply.replyTo.userName}}">回复 {{reply.replyTo.userName}}：</text>
                  {{reply.content}}
                </view>
                <view class="reply-actions">
                  <view class="action-item" bindtap="replyComment" data-id="{{item._id}}" data-name="{{reply.creatorName}}" data-parent="{{reply._id}}">
                    <text class="action-icon">💬</text>
                    <text class="action-text">回复</text>
                  </view>
                  <view class="action-item" bindtap="likeComment" data-id="{{reply._id}}">
                    <text class="action-icon">👍</text>
                    <text class="action-text">{{reply.likes || 0}}</text>
                  </view>
                </view>
              </view>
            </block>
            
            <!-- 查看更多回复 -->
            <view class="more-replies" wx:if="{{item.replyCount > item.replies.length}}" bindtap="loadMoreReplies" data-id="{{item._id}}">
              查看更多回复...
            </view>
          </view>
        </view>
      </block>
      
      <!-- 加载更多评论 -->
      <view class="load-more" bindtap="loadMoreComments" wx:if="{{hasMoreComments}}">
        加载更多评论...
      </view>
      
      <!-- 暂无评论 -->
      <view class="empty-comments" wx:if="{{comments.length === 0}}">
        暂无评论，快来发表第一条评论吧！
      </view>
    </view>
  </view>

  <!-- 创建一个wxs模块来生成弹幕样式 -->
  <wxs module="danmakuStyle">
    function getStyle(top, duration) {
      return "top:" + top + "%; animation-duration:" + duration + "ms; animation-name:danmaku;";
    }
    module.exports = {
      getStyle: getStyle
    };
  </wxs>

  <!-- 弹幕层 -->
  <view class="danmaku-layer">
    <view 
      class="danmaku-item" 
      wx:for="{{danmakuList}}" 
      wx:key="id"
      style="{{danmakuStyle.getStyle(item.top, item.duration)}}"
    >
      {{item.text}}
    </view>
  </view>
  
  <!-- 弹窗 -->
  <view class="modal-overlay" wx:if="{{modalType !== ''}}" bindtap="closeModal">
    <view class="modal-content card" catchtap="stopPropagation">
      <button class="modal-close-btn" bindtap="closeModal">✕</button>
      
      <view class="modal-header">
        <text class="modal-title h2">{{modalTitle}}</text>
      </view>
      
      <view class="modal-body p-16">
        <!-- 事迹弹窗 -->
        <view wx:if="{{modalType === 'achievement'}}" class="achievement-modal flex flex-col gap-16">
          <textarea 
            class="achievement-textarea" 
            placeholder="说说TA的精彩事迹..." 
            value="{{newAchievement}}"
            bindinput="onAchievementInput"
          ></textarea>
          <button 
            class="modal-btn btn btn-primary" 
            bindtap="submitAchievement"
            disabled="{{!newAchievement.trim()}}"
          >
            添加事迹
          </button>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 返回按钮 -->
  <view class="back-to-home-btn" bindtap="goBackToHome">
    <text class="back-icon">←</text>
  </view>
  
  <!-- 登录授权弹窗 -->
  <auth-dialog id="authDialog"></auth-dialog>
</view>