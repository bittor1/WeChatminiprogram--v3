<view class="container">
  <view class="header">
    <view class="back-button" bindtap="goBack"><text class="back-icon">←</text></view>
    <text class="header-title">我的音效</text>
    <view class="header-placeholder"></view>
  </view>

  <view class="content">
    <view class="card">
      <view class="row">
        <text class="label">启用投票音效</text>
        <switch checked="{{enabled}}" bindchange="toggleEnable" />
      </view>
      <view class="row">
        <text class="label">当前音效</text>
        <text class="value">{{soundUrl ? '已设置' : '未设置'}}</text>
      </view>
      <view class="actions">
        <button class="btn" bindtap="previewSound" disabled="{{!soundUrl || recordingState !== 'idle'}}">预览</button>
      </view>
    </view>

    <!-- 录音控制区域 -->
    <view class="recorder-card">
      <!-- 空闲状态 -->
      <block wx:if="{{recordingState === 'idle'}}">
        <view class="record-idle">
          <button class="btn primary record-btn" bindtap="recordNew">
            <image class="icon" src="/images/mic-icon.png"></image>
            录制新的音效
          </button>
        </view>
      </block>

      <!-- 录制中状态 -->
      <block wx:if="{{recordingState === 'recording'}}">
        <view class="record-in-progress">
          <view class="timer">{{formattedRecordTime}}</view>
          <view class="recording-tip">正在录音...</view>
          <button class="btn stop-btn" bindtap="stopRecord">停止录音</button>
        </view>
      </block>
      
      <!-- 试听状态 -->
      <block wx:if="{{recordingState === 'recorded'}}">
        <view class="record-playback">
          <view class="playback-controls">
            <button class="btn playback-btn" bindtap="playTempSound">
              <image class="icon" src="/images/play-icon.png"></image>
              试听 ({{formattedTempDuration}}s)
            </button>
          </view>
          <view class="playback-actions">
            <button class="btn" bindtap="recordNew">重新录制</button>
            <button class="btn primary" bindtap="uploadAndSave">保存音效</button>
          </view>
        </view>
      </block>
    </view>
    
    <!-- 用户音效库 -->
    <view class="user-sounds-section">
      <view class="section-header" bindtap="toggleUserSounds">
        <text class="section-title">我的音效库 ({{userSounds.length}})</text>
        <text class="toggle-icon">{{showUserSounds ? '▼' : '▶'}}</text>
      </view>
      
      <view wx:if="{{showUserSounds}}" class="user-sounds-list">
        <block wx:if="{{userSounds.length > 0}}">
          <view class="user-sound-item" wx:for="{{userSounds}}" wx:key="_id">
            <view class="sound-info">
              <text class="sound-name">{{item.name || '投票音效'}}</text>
              <text class="sound-duration">{{item.formattedDuration}}s</text>
              <text class="sound-date">{{item.formattedCreateTime}}</text>
            </view>
            <view class="sound-actions">
              <button class="action-btn preview-btn" 
                      bindtap="previewUserSound" 
                      data-sound-id="{{item._id}}" 
                      data-file-id="{{item.fileId}}">
                <image class="action-icon" src="/images/play-icon.png"></image>
                预览
              </button>
              <button class="action-btn apply-btn" 
                      bindtap="applyUserSound" 
                      data-sound-id="{{item._id}}" 
                      data-file-id="{{item.fileId}}" 
                      data-name="{{item.name}}">
                确认音效
              </button>
              <button class="action-btn delete-btn" 
                      bindtap="deleteUserSound" 
                      data-sound-id="{{item._id}}" 
                      data-name="{{item.name}}">
                删除
              </button>
            </view>
          </view>
        </block>
        
        <view wx:else class="empty-sounds">
          <text class="empty-text">暂无音效，录制一个试试吧！</text>
        </view>
      </view>
    </view>
    
    <view class="tip">提示：录制完成后，您可以试听并决定是否保存。</view>
  </view>
</view> 