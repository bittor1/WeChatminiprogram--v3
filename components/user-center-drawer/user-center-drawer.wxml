<!-- é®ç½©å±‚ -->
<view class="drawer-mask {{visible ? 'visible' : ''}}" bindtap="onMaskTap" style="z-index: 999;"></view>

<!-- ä¸»æŠ½å±‰é¢æ¿ -->
<view class="drawer-container {{visible ? 'visible' : ''}}" style="padding-top: {{topOffset}}px;" catchall bindtap="stopPropagation">
  
  <!-- å†…å®¹åŒºåŸŸï¼ˆå¯æ»šåŠ¨ï¼‰ -->
  <view class="drawer-content">
    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
    <view class="user-info-section">
      <!-- å·²ç™»å½•çŠ¶æ€ -->
      <block wx:if="{{userInfo}}">
        <view class="user-avatar-container">
          <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/placeholder-user.jpg'}}" mode="aspectFill"></image>
        </view>
        <view class="user-details">
          <text class="user-name">{{userInfo.nickname || userInfo.name || 'æˆæƒç”¨æˆ·'}}</text>
          <text class="user-status">{{(userInfo.votes || 0) + ' äººæƒ³åƒ'}}</text>
        </view>
      </block>
      
      <!-- æœªç™»å½•çŠ¶æ€ -->
      <block wx:else>
        <view class="user-avatar-container" catchtap="openScanLogin">
          <image class="user-avatar" src="/images/placeholder-user.jpg" mode="aspectFill"></image>
        </view>
        <view class="user-details" catchtap="openScanLogin">
          <text class="user-name">ç‚¹å‡»æ‰«ç ç™»å½•</text>
          <text class="user-status">ç™»å½•åä½“éªŒæ›´å¤šåŠŸèƒ½</text>
        </view>
      </block>
    </view>

    <!-- ç”¨æˆ·ç»Ÿè®¡åŒºåŸŸ -->
    <view class="user-stats" wx:if="{{userStatistics}}">
      <view class="stat-item">
        <text class="stat-value">{{userStatistics.nominationsCount || 0}}</text>
        <text class="stat-label">æå</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{userStatistics.votesCount || 0}}</text>
        <text class="stat-label">æŠ•ç¥¨</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{userStatistics.receivedVotesCount || 0}}</text>
        <text class="stat-label">è·èµ</text>
      </view>
    </view>

    <!-- åŠŸèƒ½åˆ—è¡¨åˆ†ç»„1 -->
    <view class="menu-group" catchtap="handleMenuItemTap">
      <view class="menu-item" data-action="orders" catchtap="showSubDrawer">
        <view class="menu-icon">ğŸ“‹</view>
        <text class="menu-text">æˆ‘çš„è®¢å•</text>
        <view class="menu-arrow">></view>
      </view>
      <view class="menu-item" data-action="nominations" catchtap="showSubDrawer">
        <view class="menu-icon">ğŸ†</view>
        <text class="menu-text">æˆ‘çš„æå</text>
        <view class="menu-arrow">></view>
      </view>
      <view class="menu-item" data-action="messages" catchtap="showSubDrawer">
        <view class="menu-icon">ğŸ‘</view>
        <text class="menu-text">æˆ‘çš„æ¶ˆæ¯</text>
        <view wx:if="{{unreadMessageCount > 0}}" class="badge">{{unreadMessageCount}}</view>
        <view class="menu-arrow">></view>
      </view>
      <view class="menu-item" data-action="sounds" catchtap="showSubDrawer">
        <view class="menu-icon">ğŸ”Š</view>
        <text class="menu-text">æˆ‘çš„éŸ³æ•ˆ</text>
        <view class="menu-arrow">></view>
      </view>
    </view>

    <!-- åŠŸèƒ½åˆ—è¡¨åˆ†ç»„2 -->
    <view class="menu-group" catchtap="handleMenuItemTap">
      <view class="menu-item" data-action="about" catchtap="showSubDrawer">
        <view class="menu-icon">â„¹ï¸</view>
        <text class="menu-text">å…³äºæ¦œå•</text>
        <view class="menu-arrow">></view>
      </view>
    </view>
    
    <!-- åº•éƒ¨å¡«å……ï¼Œç¡®ä¿å†…å®¹ä¸è¢«é€€å‡ºæŒ‰é’®é®æŒ¡ -->
    <view class="bottom-padding"></view>
  </view>
  
  <!-- é€€å‡ºç™»å½• -->
  <view class="logout-section" wx:if="{{userInfo}}">
    <button class="logout-btn" catchtap="logout">é€€å‡ºç™»å½•</button>
  </view>
</view>

<!-- å­æŠ½å±‰ - æˆ‘çš„è®¢å• -->
<view wx:if="{{activeSubDrawer === 'orders'}}" class="sub-drawer {{subDrawerVisible ? 'visible' : ''}}" catchtap="stopPropagation">
  <view class="sub-drawer-header">
    <text class="sub-drawer-title">æˆ‘çš„è®¢å•</text>
  </view>
  <view class="sub-drawer-content">
    <!-- è®¢å•å†…å®¹ -->
    <view class="empty-state">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-text">æš‚æ— è®¢å•è®°å½•</text>
    </view>
  </view>
</view>

<!-- å­æŠ½å±‰ - æˆ‘çš„æå -->
<view wx:if="{{activeSubDrawer === 'nominations'}}" class="sub-drawer {{subDrawerVisible ? 'visible' : ''}}" catchtap="stopPropagation">
  <view class="sub-drawer-header">
    <text class="sub-drawer-title">æˆ‘çš„æå</text>
    <button class="header-btn" catchtap="refreshNominations">åˆ·æ–°</button>
  </view>
  <view class="sub-drawer-content">

    <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{nominationsLoading}}" class="skeleton-list">
      <view class="skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
        <view class="skeleton-avatar"></view>
        <view class="skeleton-name"></view>
        <view class="skeleton-actions">
          <view class="skeleton-btn"></view>
          <view class="skeleton-btn"></view>
        </view>
      </view>
    </view>
    
    <!-- æååˆ—è¡¨ -->
    <scroll-view 
      wx:elif="{{nominations && nominations.length > 0}}" 
      class="nominations-list"
      scroll-y="{{true}}"
      refresher-enabled="{{true}}"
      refresher-triggered="{{nominationsRefreshing}}"
      bindrefresherrefresh="onNominationsRefresh">
      <entry-card 
        wx:for="{{nominations}}" 
        wx:key="_id"
        entry="{{item}}"
        bind:updated="onEntryUpdated"
        bind:deleted="onEntryDeleted">
      </entry-card>
    </scroll-view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:else class="empty-state">
      <text class="empty-icon">ğŸ†</text>
      <text class="empty-text">æš‚æ— æåè®°å½•</text>
      <button class="empty-action-btn" catchtap="goToCreate">ç«‹å³æå</button>
    </view>
  </view>
</view>

<!-- å­æŠ½å±‰ - æˆ‘çš„æ¶ˆæ¯ -->
<view wx:if="{{activeSubDrawer === 'messages'}}" class="sub-drawer {{subDrawerVisible ? 'visible' : ''}}" catchtap="stopPropagation">
  <view class="sub-drawer-header">
    <text class="sub-drawer-title">æˆ‘çš„æ¶ˆæ¯</text>
    <button class="header-btn" catchtap="markAllMessagesAsRead">å…¨éƒ¨å·²è¯»</button>
  </view>
  <view class="sub-drawer-content">
    <!-- æ¶ˆæ¯åˆ†ç±»æ ‡ç­¾ -->
    <view class="message-tabs">
      <view class="tab {{activeMessageTab === 'all' ? 'active' : ''}}" catchtap="switchMessageTab" data-tab="all">
        å…¨éƒ¨
        <view class="tab-badge" wx:if="{{messageCounts.all > 0}}">{{messageCounts.all}}</view>
      </view>
      <view class="tab {{activeMessageTab === 'comment' ? 'active' : ''}}" catchtap="switchMessageTab" data-tab="comment">
        è¯„è®º
        <view class="tab-badge" wx:if="{{messageCounts.comment > 0}}">{{messageCounts.comment}}</view>
      </view>
      <view class="tab {{activeMessageTab === 'vote' ? 'active' : ''}}" catchtap="switchMessageTab" data-tab="vote">
        æŠ•ç¥¨
        <view class="tab-badge" wx:if="{{messageCounts.vote > 0}}">{{messageCounts.vote}}</view>
      </view>
    </view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{messagesLoading}}" class="loading-state">
      <text class="loading-icon">â³</text>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view wx:elif="{{messages.length > 0}}" class="messages-list">
      <view class="message-item {{item.isRead ? '' : 'unread'}}" wx:for="{{messages}}" wx:key="_id">
        <view class="message-avatar">
          <image src="{{item.fromUserAvatar || '/images/placeholder-user.jpg'}}" mode="aspectFill"></image>
        </view>
        <view class="message-content">
          <view class="message-header">
            <text class="message-from">{{item.fromUserName || 'åŒ¿åç”¨æˆ·'}}</text>
            <text class="message-time">{{item.formattedTime}}</text>
          </view>
          <text class="message-text">{{item.content}}</text>
          <view wx:if="{{item.relatedNomination}}" class="message-related">
            <text class="related-label">ç›¸å…³æåï¼š</text>
            <text class="related-name">{{item.relatedNomination.name}}</text>
          </view>
        </view>
        <view class="message-actions">
          <button class="action-btn reply-btn" catchtap="replyMessage" data-id="{{item._id}}">å›å¤</button>
          <button class="action-btn delete-btn" catchtap="deleteMessage" data-id="{{item._id}}">åˆ é™¤</button>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:else class="empty-state">
      <text class="empty-icon">ğŸ’¬</text>
      <text class="empty-text">æš‚æ— æ¶ˆæ¯è®°å½•</text>
    </view>
  </view>
</view>

<!-- å­æŠ½å±‰ - æˆ‘çš„éŸ³æ•ˆ -->
<view wx:if="{{activeSubDrawer === 'sounds'}}" class="sub-drawer {{subDrawerVisible ? 'visible' : ''}}" catchtap="stopPropagation">
  <view class="sub-drawer-header">
    <text class="sub-drawer-title">æˆ‘çš„éŸ³æ•ˆ</text>
    <button class="header-btn" catchtap="refreshSounds">åˆ·æ–°</button>
  </view>
  <view class="sub-drawer-content">
    <!-- éŸ³æ•ˆè®¾ç½® -->
    <view class="sound-settings">
      <view class="setting-item">
        <text class="setting-label">å¯ç”¨æŠ•ç¥¨éŸ³æ•ˆ</text>
        <switch checked="{{soundEnabled}}" bindchange="toggleSoundEnabled" />
      </view>
      <view class="setting-item">
        <text class="setting-label">å½“å‰éŸ³æ•ˆ</text>
        <text class="setting-value">{{currentSoundName || 'æœªè®¾ç½®'}}</text>
      </view>
      <view class="setting-actions">
        <button class="setting-btn" catchtap="previewCurrentSound" disabled="{{!currentSoundUrl}}">é¢„è§ˆ</button>
        <button class="setting-btn primary" catchtap="startRecording" disabled="{{recordingState !== 'idle'}}">
          {{recordingState === 'recording' ? 'å½•éŸ³ä¸­...' : 'å½•åˆ¶æ–°éŸ³æ•ˆ'}}
        </button>
      </view>
    </view>
    
    <!-- å½•éŸ³æ§åˆ¶ -->
    <view wx:if="{{recordingState !== 'idle'}}" class="recording-control">
      <view class="recording-info">
        <text class="recording-time">{{formattedRecordTime}}</text>
        <text class="recording-status">{{recordingState === 'recording' ? 'æ­£åœ¨å½•éŸ³' : 'å½•éŸ³å®Œæˆ'}}</text>
      </view>
      <view class="recording-actions">
        <button wx:if="{{recordingState === 'recording'}}" class="control-btn stop-btn" catchtap="stopRecording">åœæ­¢å½•éŸ³</button>
        <block wx:elif="{{recordingState === 'recorded'}}">
          <button class="control-btn play-btn" catchtap="playRecording">è¯•å¬</button>
          <button class="control-btn save-btn" catchtap="saveRecording">ä¿å­˜éŸ³æ•ˆ</button>
          <button class="control-btn cancel-btn" catchtap="cancelRecording">é‡æ–°å½•åˆ¶</button>
        </block>
      </view>
    </view>
    
    <!-- éŸ³æ•ˆåº“ -->
    <view class="sounds-library">
      <view class="library-header" catchtap="toggleSoundsLibrary">
        <text class="library-title">æˆ‘çš„éŸ³æ•ˆåº“ ({{userSounds.length}})</text>
        <text class="toggle-icon">{{showSoundsLibrary ? 'â–¼' : 'â–¶'}}</text>
      </view>
      
      <view wx:if="{{showSoundsLibrary}}" class="sounds-list">
        <!-- åŠ è½½çŠ¶æ€ -->
        <view wx:if="{{soundsLoading}}" class="loading-state">
          <text class="loading-icon">â³</text>
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
        
        <!-- éŸ³æ•ˆåˆ—è¡¨ -->
        <view wx:elif="{{userSounds.length > 0}}" class="sound-items">
          <view class="sound-item" wx:for="{{userSounds}}" wx:key="_id">
            <view class="sound-info">
              <text class="sound-name">{{item.name || 'æŠ•ç¥¨éŸ³æ•ˆ'}}</text>
              <text class="sound-duration">{{item.formattedDuration}}s</text>
              <text class="sound-date">{{item.formattedCreateTime}}</text>
            </view>
            <view class="sound-actions">
              <button class="action-btn preview-btn" catchtap="previewUserSound" data-sound-id="{{item._id}}" data-file-id="{{item.fileId}}">é¢„è§ˆ</button>
              <button class="action-btn apply-btn" catchtap="applyUserSound" data-sound-id="{{item._id}}" data-file-id="{{item.fileId}}" data-name="{{item.name}}">ä½¿ç”¨</button>
              <button class="action-btn delete-btn" catchtap="deleteUserSound" data-sound-id="{{item._id}}" data-name="{{item.name}}">åˆ é™¤</button>
            </view>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view wx:else class="empty-state">
          <text class="empty-icon">ğŸ”Š</text>
          <text class="empty-text">æš‚æ— éŸ³æ•ˆï¼Œå½•åˆ¶ä¸€ä¸ªè¯•è¯•å§ï¼</text>
        </view>
      </view>
    </view>
    
    <view class="tip">æç¤ºï¼šå½•åˆ¶å®Œæˆåï¼Œæ‚¨å¯ä»¥è¯•å¬å¹¶å†³å®šæ˜¯å¦ä¿å­˜ã€‚</view>
  </view>
</view>

<!-- å­æŠ½å±‰ - å…³äºæ¦œå• -->
<view wx:if="{{activeSubDrawer === 'about'}}" class="sub-drawer {{subDrawerVisible ? 'visible' : ''}}" catchtap="stopPropagation">
  <view class="sub-drawer-header">
    <text class="sub-drawer-title">å…³äºæ¦œå•</text>
  </view>
  <view class="sub-drawer-content">
    <!-- å…³äºå†…å®¹ -->
    <view class="about-content">
      <text class="about-title">ä¼¦æ•¦å¿…åƒæ¦œ</text>
      <text class="about-version">ç‰ˆæœ¬ 1.0.0</text>
      <text class="about-desc">ä¸€ä¸ªæœ‹å‹åœˆå¨±ä¹äº’åŠ¨çš„å¾®ä¿¡å°ç¨‹åºï¼Œä¸“ä¸ºåœ¨ä¼¦æ•¦çš„æœ‹å‹ä»¬è®¾è®¡çš„ç¤¾äº¤å¨±ä¹æ’è¡Œæ¦œã€‚</text>
    </view>
  </view>
</view> 