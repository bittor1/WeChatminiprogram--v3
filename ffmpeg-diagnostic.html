<!DOCTYPE html>
<html>
<head>
    <title>FFmpegå±‚è¯Šæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; border-left: 4px solid #f44336; }
        .success { background: #e6ffe6; border-left: 4px solid #4caf50; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        button { 
            padding: 12px 24px; 
            margin: 10px 5px; 
            cursor: pointer; 
            background: #007cba; 
            color: white; 
            border: none; 
            border-radius: 4px; 
        }
        button:hover { background: #005a8b; }
        pre { 
            overflow-x: auto; 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px;
            font-size: 12px;
        }
        .status { 
            display: inline-block; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 11px; 
            font-weight: bold;
        }
        .status.exists { background: #d4edda; color: #155724; }
        .status.missing { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ğŸ” FFmpegå±‚è¯Šæ–­å·¥å…·</h1>
    
    <div class="result">
        <h3>ğŸ“‹ æ“ä½œæ­¥éª¤ï¼š</h3>
        <ol>
            <li><strong>ä¸Šä¼ äº‘å‡½æ•°</strong>ï¼šç¡®ä¿ videoToGif äº‘å‡½æ•°å·²é‡æ–°ä¸Šä¼ </li>
            <li><strong>è¿è¡Œè¯Šæ–­</strong>ï¼šç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ£€æŸ¥FFmpegå±‚çŠ¶æ€</li>
            <li><strong>åˆ†æç»“æœ</strong>ï¼šæŸ¥çœ‹è¯¦ç»†çš„è·¯å¾„å’Œæƒé™ä¿¡æ¯</li>
        </ol>
    </div>
    
    <button onclick="runFFmpegDiagnostic()">ğŸ” è¿è¡ŒFFmpegå±‚è¯Šæ–­</button>
    <button onclick="testSimpleCall()">ğŸ§ª æµ‹è¯•äº‘å‡½æ•°è°ƒç”¨</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    
    <div id="results"></div>

    <script>
        function showResult(title, content, type = 'success') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            
            let formattedContent = content;
            if (typeof content === 'object') {
                formattedContent = JSON.stringify(content, null, 2);
            }
            
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${formattedContent}</pre>
            `;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function formatDiagnosticResult(diagnostic) {
            let output = '=== FFmpegè·¯å¾„æ£€æŸ¥ ===\n';
            
            for (const [path, info] of Object.entries(diagnostic.paths)) {
                if (info.exists) {
                    output += `âœ… ${path}\n`;
                    output += `   - æ–‡ä»¶å¤§å°: ${(info.size / 1024 / 1024).toFixed(1)}MB\n`;
                    output += `   - æƒé™æ¨¡å¼: ${info.mode}\n`;
                    output += `   - æ˜¯å¦ä¸ºæ–‡ä»¶: ${info.isFile}\n\n`;
                } else {
                    output += `âŒ ${path} - ä¸å­˜åœ¨\n\n`;
                }
            }
            
            output += '=== ç›®å½•ç»“æ„ ===\n';
            for (const [dir, contents] of Object.entries(diagnostic.directoryContents)) {
                output += `ğŸ“ ${dir}:\n`;
                if (Array.isArray(contents)) {
                    contents.forEach(item => output += `   - ${item}\n`);
                } else {
                    output += `   ${contents}\n`;
                }
                output += '\n';
            }
            
            output += '=== ç¯å¢ƒå˜é‡ ===\n';
            output += `PATH: ${diagnostic.environment.PATH}\n`;
            output += `LD_LIBRARY_PATH: ${diagnostic.environment.LD_LIBRARY_PATH || '(æœªè®¾ç½®)'}\n`;
            output += `HOME: ${diagnostic.environment.HOME}\n`;
            
            return output;
        }

        async function runFFmpegDiagnostic() {
            try {
                showResult('ğŸ” è¯Šæ–­å¼€å§‹', 'æ­£åœ¨æ£€æŸ¥FFmpegå±‚é…ç½®...', 'warning');
                
                const res = await wx.cloud.callFunction({
                    name: 'videoToGif',
                    data: { diagnose: true }
                });

                if (res.result && res.result.success && res.result.diagnostic) {
                    const formatted = formatDiagnosticResult(res.result.diagnostic);
                    showResult('âœ… FFmpegå±‚è¯Šæ–­ç»“æœ', formatted, 'success');
                    
                    // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°FFmpeg
                    const foundFFmpeg = Object.values(res.result.diagnostic.paths).some(info => info.exists);
                    if (!foundFFmpeg) {
                        showResult('âš ï¸ é—®é¢˜åˆ†æ', 
                            'æ²¡æœ‰æ‰¾åˆ°FFmpegå¯æ‰§è¡Œæ–‡ä»¶ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\n' +
                            '1. FFmpegå±‚æ²¡æœ‰æ­£ç¡®ç»‘å®šåˆ°äº‘å‡½æ•°\n' +
                            '2. å±‚çš„ç›®å½•ç»“æ„ä¸æ­£ç¡®\n' +
                            '3. FFmpegæ–‡ä»¶æƒé™é—®é¢˜\n\n' +
                            'å»ºè®®è§£å†³æ–¹æ¡ˆï¼š\n' +
                            '1. æ£€æŸ¥äº‘å¼€å‘æ§åˆ¶å°ä¸­çš„å±‚ç»‘å®š\n' +
                            '2. é‡æ–°ä¸Šä¼ FFmpegå±‚\n' +
                            '3. ç¡®ä¿å±‚å†…éƒ¨ç»“æ„ä¸º: bin/ffmpeg', 
                            'error');
                    }
                } else {
                    showResult('âŒ è¯Šæ–­å¤±è´¥', res.result || res, 'error');
                }
            } catch (error) {
                showResult('âŒ è¯Šæ–­é”™è¯¯', 
                    `é”™è¯¯ä¿¡æ¯: ${error.message}\n\nè¿™å¯èƒ½è¡¨ç¤ºï¼š\n` +
                    '1. äº‘å‡½æ•°æ²¡æœ‰æ­£ç¡®éƒ¨ç½²\n' +
                    '2. äº‘å‡½æ•°æ‰§è¡Œæƒé™é—®é¢˜\n' +
                    '3. ç½‘ç»œè¿æ¥é—®é¢˜', 'error');
            }
        }

        async function testSimpleCall() {
            try {
                showResult('ğŸ§ª æµ‹è¯•å¼€å§‹', 'æµ‹è¯•äº‘å‡½æ•°åŸºæœ¬è°ƒç”¨...', 'warning');
                
                const res = await wx.cloud.callFunction({
                    name: 'videoToGif',
                    data: { 
                        fileID: 'test-file-id'  // æ•…æ„ä¼ å…¥æ— æ•ˆIDæ¥æµ‹è¯•äº‘å‡½æ•°å“åº”
                    }
                });

                showResult('ğŸ“‹ äº‘å‡½æ•°å“åº”', res.result, 'success');
            } catch (error) {
                showResult('âŒ äº‘å‡½æ•°è°ƒç”¨å¤±è´¥', error.message || error, 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // æ£€æŸ¥ç¯å¢ƒ
        window.onload = function() {
            if (typeof wx === 'undefined') {
                showResult('âŒ ç¯å¢ƒé”™è¯¯', 
                    'è¯·åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€æ­¤é¡µé¢ï¼\n\n' +
                    'æ­¥éª¤ï¼š\n' +
                    '1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­\n' +
                    '2. ç‚¹å‡»"é¢„è§ˆ" â†’ "é€‰æ‹©æœ¬åœ°æ–‡ä»¶"\n' +
                    '3. é€‰æ‹©æ­¤HTMLæ–‡ä»¶', 'error');
            } else {
                showResult('âœ… ç¯å¢ƒæ£€æŸ¥', 'å¾®ä¿¡å¼€å‘ç¯å¢ƒå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹è¯Šæ–­', 'success');
            }
        };
    </script>
</body>
</html>
