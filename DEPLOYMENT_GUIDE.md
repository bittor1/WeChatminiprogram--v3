# üöÄ ËßÜÈ¢ëÂä†ËΩΩ500ÈîôËØØ‰øÆÂ§ç - ÈÉ®ÁΩ≤ÊåáÂçó

## üì¶ ‰øÆÂ§çÂÜÖÂÆπÊ¶ÇËßà

Êú¨Ê¨°‰øÆÂ§ç‰∏ªË¶ÅËß£ÂÜ≥‰∫ÜËßÜÈ¢ëÂä†ËΩΩÊó∂Âá∫Áé∞ÁöÑ500ÈîôËØØÔºåÂåÖÂê´‰ª•‰∏ãÊîπËøõÔºö

1. **‰∫ëÂ≠òÂÇ®URLË∑ØÂæÑ‰øÆÂ§ç**
2. **videoToGif‰∫ëÂáΩÊï∞ÈîôËØØÂ§ÑÁêÜÂ¢ûÂº∫**
3. **ÂÆ¢Êà∑Á´ØÈîôËØØÂ§ÑÁêÜ‰ºòÂåñ**
4. **ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØÊèê‰æõ**

## üõ†Ô∏è ÈÉ®ÁΩ≤Ê≠•È™§

### 1. Êõ¥Êñ∞‰∫ëÂáΩÊï∞

#### Step 1.1: ÈÉ®ÁΩ≤videoToGif‰∫ëÂáΩÊï∞

```bash
# Âú®ÂæÆ‰ø°ÂºÄÂèëËÄÖÂ∑•ÂÖ∑‰∏≠Ôºö
1. Âè≥ÈîÆÁÇπÂáª cloudfunctions/videoToGif Êñá‰ª∂Â§π
2. ÈÄâÊã©"‰∏ä‰º†Âπ∂ÈÉ®ÁΩ≤Ôºö‰∫ëÁ´ØÂÆâË£Ö‰æùËµñ"
3. Á≠âÂæÖÈÉ®ÁΩ≤ÂÆåÊàê
```

**‰øÆÊîπÂÜÖÂÆπÔºö**
- Ê∑ªÂä†‰∫Ü‰∫ëÂ≠òÂÇ®URLÊ†ºÂºè‰øÆÂ§çÂäüËÉΩ
- Â¢ûÂº∫‰∫ÜÈîôËØØÂ§ÑÁêÜÂíåÊó•ÂøóËÆ∞ÂΩï
- Êèê‰æõ‰∫ÜÊõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ª£Á†ÅÂíåÊ∂àÊÅØ

#### Step 1.2: È™åËØÅ‰∫ëÂáΩÊï∞ÈÉ®ÁΩ≤

```javascript
// Âú®ÂæÆ‰ø°ÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÊéßÂà∂Âè∞‰∏≠ÊµãËØï
wx.cloud.callFunction({
  name: 'videoToGif',
  data: {
    fileID: 'test', // Ëøô‰ºöËß¶ÂèëINVALID_FILE_ID_FORMATÈîôËØØ
  }
}).then(res => {
  console.log('ÊµãËØïÁªìÊûú:', res);
  // Â∫îËØ•ËøîÂõûÂåÖÂê´errorCodeÁöÑÈîôËØØ‰ø°ÊÅØ
});
```

### 2. Êõ¥Êñ∞Â∞èÁ®ãÂ∫è‰ª£Á†Å

#### Step 2.1: Êõ¥Êñ∞Â∑•ÂÖ∑ÂáΩÊï∞

Êñá‰ª∂Â∑≤Êõ¥Êñ∞Ôºö`utils/cloudUtils.js`
- Ê∑ªÂä†‰∫Ü `fixCloudStorageUrl` ÂáΩÊï∞
- Êõ¥Êñ∞‰∫Ü `downloadFileFromCloud` ÂáΩÊï∞‰ª•‰ΩøÁî®URL‰øÆÂ§ç

#### Step 2.2: Êõ¥Êñ∞È°µÈù¢‰ª£Á†Å

Êñá‰ª∂Â∑≤Êõ¥Êñ∞Ôºö`pages/create/create.js`
- ÊîπËøõ‰∫Ü `handleProcessingError` ÂáΩÊï∞
- Ê∑ªÂä†‰∫ÜËØ¶ÁªÜÁöÑÈîôËØØÂàÜÁ±ªÂíåÁî®Êà∑ÂèãÂ•ΩÁöÑÊèêÁ§∫

#### Step 2.3: ÂèëÂ∏ÉÂ∞èÁ®ãÂ∫è‰ª£Á†Å

```bash
# Âú®ÂæÆ‰ø°ÂºÄÂèëËÄÖÂ∑•ÂÖ∑‰∏≠Ôºö
1. ÁÇπÂáª"‰∏ä‰º†"ÊåâÈíÆ
2. Â°´ÂÜôÁâàÊú¨Âè∑ÂíåÈ°πÁõÆÂ§áÊ≥®
3. Êèê‰∫§ÂÆ°Ê†∏ÔºàÂèØÈÄâÔºâ
```

## üß™ ÊµãËØïÈ™åËØÅ

### ÊµãËØïÂú∫ÊôØ 1: URLÊ†ºÂºè‰øÆÂ§ç

**ÊµãËØïÊ≠•È™§Ôºö**
1. ÊâìÂºÄÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÊéßÂà∂Âè∞
2. ÊâßË°å‰ª•‰∏ã‰ª£Á†ÅÔºö

```javascript
const cloudUtils = require('../../utils/cloudUtils');
const testUrl = '/pages/index/cloud://cloud1-2g2sby6z920b76cb.636c-cloud1-2g2sby6z920b76cb-1373835033/videos/1756588256944.mp4';
const fixedUrl = cloudUtils.fixCloudStorageUrl(testUrl);
console.log('ÂéüÂßãURL:', testUrl);
console.log('‰øÆÂ§çÂêéURL:', fixedUrl);
```

**ÊúüÊúõÁªìÊûúÔºö**
- ‰øÆÂ§çÂêéÁöÑURLÂ∫îËØ•ÊòØÔºö`cloud://cloud1-2g2sby6z920b76cb.636c-cloud1-2g2sby6z920b76cb-1373835033/videos/1756588256944.mp4`

### ÊµãËØïÂú∫ÊôØ 2: ËßÜÈ¢ëÂ§ÑÁêÜÈîôËØØÂ§ÑÁêÜ

**ÊµãËØïÊ≠•È™§Ôºö**
1. ËøõÂÖ•ÂàõÂª∫È°µÈù¢
2. ÈÄâÊã©‰∏Ä‰∏™ËßÜÈ¢ëÊñá‰ª∂
3. ËßÇÂØüÈîôËØØÂ§ÑÁêÜÊòØÂê¶ÂèãÂ•Ω

**ÊúüÊúõÁªìÊûúÔºö**
- Â¶ÇÊûúÂ§ÑÁêÜÂ§±Ë¥•ÔºåÂ∫îÊòæÁ§∫ÂÖ∑‰ΩìÁöÑÈîôËØØ‰ø°ÊÅØ
- Áî®Êà∑ÂèØ‰ª•ÈáçÊñ∞ÈÄâÊã©Êñá‰ª∂
- ËøõÂ∫¶Êù°Ê≠£Á°ÆÈáçÁΩÆ

### ÊµãËØïÂú∫ÊôØ 3: ‰∫ëÂáΩÊï∞ÈîôËØØÁ†Å

**ÊµãËØïÊ≠•È™§Ôºö**
1. Âú®ÊéßÂà∂Âè∞Ë∞ÉÁî®‰∫ëÂáΩÊï∞Ôºö

```javascript
// ÊµãËØïÁº∫Â∞ëÊñá‰ª∂ID
wx.cloud.callFunction({
  name: 'videoToGif',
  data: {}
}).then(res => {
  console.log('Áº∫Â∞ëÊñá‰ª∂IDÊµãËØï:', res.result);
  // ÊúüÊúõ: errorCode: 'MISSING_FILE_ID'
});

// ÊµãËØïÊó†ÊïàÊñá‰ª∂IDÊ†ºÂºè
wx.cloud.callFunction({
  name: 'videoToGif',
  data: {
    fileID: 'invalid-id'
  }
}).then(res => {
  console.log('Êó†ÊïàIDÊµãËØï:', res.result);
  // ÊúüÊúõ: errorCode: 'INVALID_FILE_ID_FORMAT'
});
```

## üîç ÁõëÊéßÂíåÊó•Âøó

### Êü•Áúã‰∫ëÂáΩÊï∞Êó•Âøó

1. ÊâìÂºÄÂæÆ‰ø°ÂºÄÂèëËÄÖÂ∑•ÂÖ∑
2. ËøõÂÖ•"‰∫ëÂºÄÂèë"ÊéßÂà∂Âè∞
3. ÁÇπÂáª"‰∫ëÂáΩÊï∞"
4. ÈÄâÊã©"videoToGif"
5. Êü•Áúã"Êó•Âøó"Ê†áÁ≠æ

**ÂÖ≥ÈîÆÊó•ÂøóÁ§∫‰æãÔºö**
```
[INFO] ÂºÄÂßãÂ§ÑÁêÜËßÜÈ¢ëËΩ¨GIFÔºåÂéüÂßãfileID: /pages/index/cloud://..., ‰øÆÂ§çÂêé: cloud://...
[INFO] ËßÜÈ¢ë‰∏ãËΩΩÊàêÂäüÔºåÂ§ßÂ∞è: 1234567
[INFO] FFmpegÂëΩ‰ª§: ffmpeg -i input.mp4 -vf scale=200:200 output.gif
[ERROR] ËßÜÈ¢ë‰∏ãËΩΩÂ§±Ë¥•: Error downloading file
```

### ÈîôËØØÂàÜÁ±ªÁªüËÆ°

Âª∫ËÆÆÊî∂ÈõÜ‰ª•‰∏ãÈîôËØØÁ±ªÂûãÁöÑÁªüËÆ°Ôºö
- `MISSING_FILE_ID`: Áº∫Â∞ëÊñá‰ª∂ID
- `INVALID_FILE_ID_FORMAT`: Êñá‰ª∂IDÊ†ºÂºèÈîôËØØ
- `DOWNLOAD_FAILED`: ‰∏ãËΩΩÂ§±Ë¥•
- `PROCESSING_FAILED`: Â§ÑÁêÜÂ§±Ë¥•
- `UPLOAD_FAILED`: ‰∏ä‰º†Â§±Ë¥•

## üìä ÊÄßËÉΩ‰ºòÂåñÂª∫ËÆÆ

### 1. È¢ÑÈò≤ÊÄßÊé™ÊñΩ

```javascript
// Âú®‰∏ä‰º†ÂâçÈ™åËØÅÊñá‰ª∂
const validateVideoFile = (filePath) => {
  return new Promise((resolve, reject) => {
    wx.getVideoInfo({
      src: filePath,
      success: (res) => {
        if (res.duration > 15) {
          reject(new Error('ËßÜÈ¢ëÊó∂Èïø‰∏çËÉΩË∂ÖËøá15Áßí'));
        } else if (res.size > 10 * 1024 * 1024) {
          reject(new Error('ËßÜÈ¢ëÊñá‰ª∂‰∏çËÉΩË∂ÖËøá10MB'));
        } else {
          resolve(res);
        }
      },
      fail: reject
    });
  });
};
```

### 2. ÁºìÂ≠òÊú∫Âà∂

```javascript
// ÁºìÂ≠òÂ§ÑÁêÜËøáÁöÑGIF
const cacheGifResult = (videoFileID, gifFileID) => {
  const cacheKey = `gif_cache_${videoFileID}`;
  wx.setStorageSync(cacheKey, {
    gifFileID,
    timestamp: Date.now()
  });
};

const getCachedGif = (videoFileID) => {
  const cacheKey = `gif_cache_${videoFileID}`;
  const cached = wx.getStorageSync(cacheKey);
  
  // ÁºìÂ≠ò24Â∞èÊó∂
  if (cached && Date.now() - cached.timestamp < 24 * 60 * 60 * 1000) {
    return cached.gifFileID;
  }
  
  return null;
};
```

## üö® ÊïÖÈöúÊéíÈô§

### Â∏∏ËßÅÈóÆÈ¢ò 1: ‰∫ëÂáΩÊï∞Ë∂ÖÊó∂

**ÁóáÁä∂Ôºö** ËßÜÈ¢ëÂ§ÑÁêÜÊó∂Èó¥ËøáÈïøÂØºËá¥Ë∂ÖÊó∂

**Ëß£ÂÜ≥ÊñπÊ°àÔºö**
1. Âú®‰∫ëÂáΩÊï∞ÈÖçÁΩÆ‰∏≠Â¢ûÂä†Ë∂ÖÊó∂Êó∂Èó¥
2. ÂØπÂ§ßÊñá‰ª∂ËøõË°åÈ¢ÑÂ§ÑÁêÜÔºåÂáèÂ∞ëÊó∂ÈïøÊàñÂàÜËæ®Áéá

### Â∏∏ËßÅÈóÆÈ¢ò 2: FFmpeg‰∏çÂèØÁî®

**ÁóáÁä∂Ôºö** Âá∫Áé∞ `FFMPEG_NOT_AVAILABLE` ÈîôËØØ

**Ëß£ÂÜ≥ÊñπÊ°àÔºö**
1. Á°ÆËÆ§FFmpegÂ±ÇÊ≠£Á°ÆÈÉ®ÁΩ≤
2. Ê£ÄÊü•‰∫ëÂáΩÊï∞‰∏≠FFmpegË∑ØÂæÑËÆæÁΩÆ

### Â∏∏ËßÅÈóÆÈ¢ò 3: ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò

**ÁóáÁä∂Ôºö** È¢ëÁπÅÂá∫Áé∞‰∏ãËΩΩÊàñ‰∏ä‰º†Â§±Ë¥•

**Ëß£ÂÜ≥ÊñπÊ°àÔºö**
1. Ê∑ªÂä†ÈáçËØïÊú∫Âà∂
2. Ê£ÄÊü•Áî®Êà∑ÁΩëÁªúÁéØÂ¢É
3. Êèê‰æõÈôçÁ∫ßÊñπÊ°àÔºà‰ΩøÁî®ÈùôÊÄÅÂõæÁâáÔºâ

## üìû ÊîØÊåÅËÅîÁ≥ª

Â¶ÇÊûúÂú®ÈÉ®ÁΩ≤ËøáÁ®ã‰∏≠ÈÅáÂà∞ÈóÆÈ¢òÔºö

1. **Ê£ÄÊü•Êó•Âøó**Ôºö‰ºòÂÖàÊü•Áúã‰∫ëÂáΩÊï∞ÂíåÂ∞èÁ®ãÂ∫èÊéßÂà∂Âè∞Êó•Âøó
2. **ÈîôËØØ‰ª£Á†Å**ÔºöÊ†πÊçÆËøîÂõûÁöÑerrorCodeÂÆö‰ΩçÈóÆÈ¢ò
3. **ÊµãËØïÁéØÂ¢É**ÔºöÂú®ÂºÄÂèëÁéØÂ¢ÉÂÖÖÂàÜÊµãËØïÂêéÂÜçÂèëÂ∏ÉÁîü‰∫ß

## üìù Êõ¥Êñ∞ËÆ∞ÂΩï

- **Version 1.1.0** (2024-01-XX)
  - ‰øÆÂ§ç‰∫ëÂ≠òÂÇ®URLË∑ØÂæÑÈóÆÈ¢ò
  - Â¢ûÂº∫ÈîôËØØÂ§ÑÁêÜÊú∫Âà∂
  - Ê∑ªÂä†ËØ¶ÁªÜÈîôËØØÂàÜÁ±ª
  - ÊîπËøõÁî®Êà∑‰ΩìÈ™å

---

**Ê≥®ÊÑè‰∫ãÈ°πÔºö**
- ÈÉ®ÁΩ≤ÂâçËØ∑Â§á‰ªΩÁé∞Êúâ‰ª£Á†Å
- Âª∫ËÆÆÂú®ÊµãËØïÁéØÂ¢ÉÂÖàÈ™åËØÅ‰øÆÂ§çÊïàÊûú
- ÁõëÊéßÈÉ®ÁΩ≤ÂêéÁöÑÈîôËØØÁéáÂèòÂåñ
